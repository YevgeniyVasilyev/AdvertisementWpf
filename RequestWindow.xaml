<Window x:Class="AdvertisementWpf.RequestWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"        
        xmlns:local="clr-namespace:AdvertisementWpf" 
        xmlns:model="clr-namespace:AdvertisementWpf.Models" 
        mc:Ignorable="d"
        WindowState="Maximized" MinHeight="700" MinWidth="1400"
        ResizeMode="CanResizeWithGrip" WindowStyle="SingleBorderWindow">
    <Window.Style>
        <Style TargetType="{x:Type Window}">
            <Setter Property="Title" Value="Заказ"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding ElementName=DateDateAdmission, Path=IsEnabled}" Value="True">
                    <Setter Property="Title" Value="Заказ (новый)"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding ElementName=SaveRequestButton, Path=IsVisible}" Value="False">
                    <Setter Property="Title" Value="Заказ (просмотр)"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Style>
    <Window.Resources>
        <ControlTemplate x:Key="SpecialTreeViewItemTemplate" TargetType="TreeViewItem">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" MinWidth="19" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition />
                </Grid.RowDefinitions>
                <ToggleButton IsChecked="False" ClickMode="Press" Name="Expander">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton">
                            <Style.Resources>
                                <ResourceDictionary />
                            </Style.Resources>
                            <Setter Property="UIElement.Focusable">
                                <Setter.Value>
                                    <System:Boolean>False</System:Boolean>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="FrameworkElement.Width">
                                <Setter.Value>
                                    <System:Double>16</System:Double>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="FrameworkElement.Height">
                                <Setter.Value>
                                    <System:Double>16</System:Double>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Control.Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Padding="5,5,5,5" Background="#00FFFFFF" Width="16" Height="16">
                                            <Path Fill="#00FFFFFF" Stroke="#FF989898" Name="ExpandPath">
                                                <Path.Data>
                                                    <PathGeometry Figures="M0,0L0,6L6,0z" />
                                                </Path.Data>
                                                <Path.RenderTransform>
                                                    <RotateTransform Angle="135" CenterX="3" CenterY="3" />
                                                </Path.RenderTransform>
                                            </Path>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="ToggleButton.IsChecked">
                                                <Setter Property="UIElement.RenderTransform" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <RotateTransform Angle="180" CenterX="3" CenterY="3" />
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Shape.Fill" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#FF595959</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Shape.Stroke" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#FF262626</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                                <Trigger.Value>
                                                    <System:Boolean>True</System:Boolean>
                                                </Trigger.Value>
                                            </Trigger>
                                            <Trigger Property="UIElement.IsMouseOver">
                                                <Setter Property="Shape.Stroke" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#FF1BBBFA</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Shape.Fill" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#00FFFFFF</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                                <Trigger.Value>
                                                    <System:Boolean>True</System:Boolean>
                                                </Trigger.Value>
                                            </Trigger>
                                            <MultiTrigger>
                                                <MultiTrigger.Conditions>
                                                    <Condition Property="UIElement.IsMouseOver">
                                                        <Condition.Value>
                                                            <System:Boolean>True</System:Boolean>
                                                        </Condition.Value>
                                                    </Condition>
                                                    <Condition Property="ToggleButton.IsChecked">
                                                        <Condition.Value>
                                                            <System:Boolean>True</System:Boolean>
                                                        </Condition.Value>
                                                    </Condition>
                                                </MultiTrigger.Conditions>
                                                <Setter Property="Shape.Stroke" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#FF262626</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Shape.Fill" TargetName="ExpandPath">
                                                    <Setter.Value>
                                                        <SolidColorBrush>#FF595959</SolidColorBrush>
                                                    </Setter.Value>
                                                </Setter>
                                            </MultiTrigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ToggleButton.Style>
                </ToggleButton>
                <Border BorderThickness="{TemplateBinding Border.BorderThickness}" Padding="{TemplateBinding Control.Padding}" BorderBrush="{TemplateBinding Border.BorderBrush}" Background="{TemplateBinding Panel.Background}" Name="Bd" SnapsToDevicePixels="True" Grid.Column="1">
                    <ContentPresenter Content="{TemplateBinding HeaderedContentControl.Header}" ContentTemplate="{TemplateBinding HeaderedContentControl.HeaderTemplate}" ContentStringFormat="{TemplateBinding HeaderedItemsControl.HeaderStringFormat}" ContentSource="Header" Name="PART_Header" HorizontalAlignment="{TemplateBinding Control.HorizontalContentAlignment}" SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}" />
                </Border>
                <ItemsPresenter Name="ItemsHost" Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2" />
            </Grid>
            <ControlTemplate.Triggers>
                <Trigger Property="TreeViewItem.IsExpanded">
                    <Setter Property="UIElement.Visibility" TargetName="ItemsHost">
                        <Setter.Value>
                            <x:Static Member="Visibility.Collapsed" />
                        </Setter.Value>
                    </Setter>
                    <Trigger.Value>
                        <System:Boolean>False</System:Boolean>
                    </Trigger.Value>
                </Trigger>
                <Trigger Property="ItemsControl.HasItems">
                    <Setter Property="UIElement.Visibility" TargetName="Expander">
                        <Setter.Value>
                            <x:Static Member="Visibility.Hidden" />
                        </Setter.Value>
                    </Setter>
                    <Trigger.Value>
                        <System:Boolean>False</System:Boolean>
                    </Trigger.Value>
                </Trigger>
                <Trigger Property="TreeViewItem.IsSelected">
                    <Setter Property="Panel.Background" TargetName="Bd">
                        <Setter.Value>
                            <DynamicResource ResourceKey="{x:Static SystemColors.HighlightBrushKey}" />
                        </Setter.Value>
                    </Setter>
                    <Setter Property="TextElement.Foreground">
                        <Setter.Value>
                            <DynamicResource ResourceKey="{x:Static SystemColors.HighlightTextBrushKey}" />
                        </Setter.Value>
                    </Setter>
                    <Trigger.Value>
                        <System:Boolean>True</System:Boolean>
                    </Trigger.Value>
                </Trigger>
                <MultiTrigger>
                    <MultiTrigger.Conditions>
                        <Condition Property="TreeViewItem.IsSelected">
                            <Condition.Value>
                                <System:Boolean>True</System:Boolean>
                            </Condition.Value>
                        </Condition>
                        <Condition Property="Selector.IsSelectionActive">
                            <Condition.Value>
                                <System:Boolean>False</System:Boolean>
                            </Condition.Value>
                        </Condition>
                    </MultiTrigger.Conditions>
                    <Setter Property="Panel.Background" TargetName="Bd">
                        <Setter.Value>
                            <DynamicResource ResourceKey="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" />
                        </Setter.Value>
                    </Setter>
                    <Setter Property="TextElement.Foreground">
                        <Setter.Value>
                            <DynamicResource ResourceKey="{x:Static SystemColors.InactiveSelectionHighlightTextBrushKey}" />
                        </Setter.Value>
                    </Setter>
                </MultiTrigger>
                <Trigger Property="UIElement.IsEnabled">
                    <Setter Property="TextElement.Foreground">
                        <Setter.Value>
                            <DynamicResource ResourceKey="{x:Static SystemColors.GrayTextBrushKey}" />
                        </Setter.Value>
                    </Setter>
                    <Trigger.Value>
                        <System:Boolean>False</System:Boolean>
                    </Trigger.Value>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>
        <Style TargetType="TreeViewItem" x:Key="SpecialTreeViewItem">
            <Setter Property="Template" Value="{DynamicResource SpecialTreeViewItemTemplate}"/>
        </Style>
        <local:CostConverter x:Key="CostConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:ValueConverterGroup x:Key="BoolToVisibilityConverter">
            <local:BoolNotBoolConverter/>
            <BooleanToVisibilityConverter/>
        </local:ValueConverterGroup>
        <local:IsCanEditAfterSendToProdToBoolConverter x:Key="IsCanEditAfterSendToProdToBoolConverter"/>
        <local:IsCanDeleteAfterSendToProdToBoolConverter x:Key="IsCanDeleteAfterSendToProdToBoolConverter"/>
        <local:NullDateTimeToBoolConverter x:Key="NullDateTimeToBoolConverter"/>
        <local:SumListViewDecimalConverter x:Key="SumListViewDecimalConverter"/>
        <local:MultiValueConverter x:Key="MultiValueConverter"/>
        <local:BoolNotBoolConverter x:Key="BoolNotBoolConverter"/>
        <local:VisibilitySelector x:Key="VisibilitySelector"/>
        <Style x:Key="DropShadow" TargetType="{x:Type FrameworkElement}">
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="0.5" Opacity="0.5"/>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="ButtonOfOrder" TargetType="{x:Type Button}" BasedOn="{StaticResource DropShadow}">
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="1,1,1,1"/>
            <Setter Property="Padding" Value="1,1,1,1"/>
            <Setter Property="Content" Value="{Binding}"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style x:Key="UnderlineTextBlock" TargetType="TextBlock">
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="ToolTip" Value="Нажмите для установки текущей даты"/>
                    <!--<Setter Property="Foreground" Value="Red"/>-->
                    <Setter Property="TextDecorations" Value="Underline"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <DataTemplate x:Key="ListViewHeaderTemplate">
            <TextBlock FontWeight="Bold" TextWrapping="Wrap" TextAlignment="Center"
                       HorizontalAlignment="Stretch" VerticalAlignment="Center">
                <TextBlock.Text>
                    <Binding/>
                </TextBlock.Text>
            </TextBlock>
        </DataTemplate>
        <Style TargetType="{x:Type TextBox}" x:Key="ValidationTemplate">
            <Setter Property="Validation.ErrorTemplate">
                <Setter.Value>
                    <ControlTemplate>
                        <DockPanel LastChildFill="True">
                            <Grid Margin="0,-2,0,-2">
                                <Ellipse StrokeThickness="0" Fill="Red" Width="{TemplateBinding FontSize}" Height="{TemplateBinding FontSize}"/>
                                <TextBlock Text="!" FontSize="{TemplateBinding FontSize}" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                            </Grid>
                            <Border BorderBrush="Red" BorderThickness="1">
                                <AdornedElementPlaceholder/>
                            </Border>
                        </DockPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="Validation.HasError" Value="True">
                    <Setter Property="ToolTip"
                            Value="{Binding RelativeSource={RelativeSource Self}, Path=(Validation.Errors)[0].ErrorContent}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <model:CommonList x:Key="CommonList"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!--кнопки управления-->
            <RowDefinition Height="Auto"/>
            <!--параметры заказа-->
            <RowDefinition Height="*"/>
            <!--параметры изделия-->
        </Grid.RowDefinitions>
        <WrapPanel Grid.Row="0" Margin="10" Orientation="Horizontal">
            <Button Name="SaveRequestButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding SaveRequest}" 
                ToolTip="Сохранить данные по заказу и изделиям в БД" Visibility="{Binding ViewMode, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Orientation="Vertical">
                    <Image Source="\Images\free-icon-floppy-disk_save.png" Width="25" Height="25"/>
                    <Label Content="Сохранить"/>
                </StackPanel>
            </Button>
            <Separator/>
            <Button Name="PrintRequestFormButton" Style="{StaticResource ButtonOfOrder}" IsEnabled="{Binding OrderCardPrintOrderForm}" 
                    Command="{Binding PrintOrderForm}" CommandParameter="{Binding ElementName=ListProduct}">
                <StackPanel Orientation="Vertical">
                    <Image Source="\Images\free-icon-printer.png" Width="25" Height="25"/>
                    <Label Content="Бланк"/>
                </StackPanel>
            </Button>
            <Button Name="PrintRequestFormForDesignerButton" Style="{StaticResource ButtonOfOrder}" IsEnabled="{Binding OrderCardPrintOrderFormForDesigner}" 
                    Command="{Binding PrintOrderFormForDesigner}">
                <StackPanel Orientation="Vertical">
                    <Image Source="\Images\free-icon-printer.png" Width="25" Height="25"/>
                    <Label Content="Бланк для дизайнера"/>
                    <Image Source="\Images\downward-arrow.png" Width="15" Height="15"/>
                </StackPanel>
                <Button.CommandParameter>
                    <MultiBinding Converter="{StaticResource MultiValueConverter}">
                        <Binding ElementName="PrintRequestFormForDesignerButton"/>
                        <Binding ElementName="ListProduct"/>
                    </MultiBinding>
                </Button.CommandParameter>
                <Button.ContextMenu>
                    <ContextMenu Visibility="Hidden">
                    </ContextMenu>
                </Button.ContextMenu>
            </Button>
        </WrapPanel>
        <StackPanel Grid.Row="1" Margin="5">
            <Border Margin="5" BorderThickness="1" BorderBrush="DarkSlateGray">
                <Grid Margin="5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="0.2*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="0.5*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="0.3*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Column="0" Grid.Row="0" Text=" Номер заказа: " VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Grid.Row="0" Text="{Binding Path=CurrentOrder.Number}" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="3" Grid.Row="0" Text=" Заказчик: " VerticalAlignment="Center"/>
                    <ComboBox  Grid.Column="4" Grid.Row="0" Name="ClientComboBox" VerticalAlignment="Center" IsEditable="False"
                               ItemsSource="{Binding ClientCollectionView}"
                               SelectedValue="{Binding Path=CurrentOrder.ClientID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"  
                               SelectedValuePath="ID" DisplayMemberPath="ShortName">
                    </ComboBox>
                    <TextBlock  Grid.Column="5" Grid.Row="0" Text=" Поиск: " VerticalAlignment="Center"/>
                    <TextBox    Grid.Column="6" Grid.Row="0" Margin="0,0,5,0" Text="{Binding Path=SearchClient, UpdateSourceTrigger=PropertyChanged}"  VerticalAlignment="Center"/>
                    <TextBlock  Grid.Column="0" Grid.Row="1" Text=" Дата приема заказа: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                        <TextBlock.InputBindings>
                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateDateAdmission}" MouseAction="LeftClick"/>
                        </TextBlock.InputBindings>
                    </TextBlock>
                    <DatePicker Grid.Column="1" Grid.Row="1" Name="DateDateAdmission" SelectedDate="{Binding Path=CurrentOrder.DateAdmission, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                IsEnabled="{Binding IsNewOrder}"
                                IsTodayHighlighted="True" VerticalAlignment="Center"/>
                    <TextBlock  Grid.Column="3" Grid.Row="1" Text=" Краткое описание: " VerticalAlignment="Center"/>
                    <TextBox    Grid.Column="4" Grid.Row="1" Text="{Binding Path=CurrentOrder.Note, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                AcceptsReturn="True" TextAlignment="Left" TextWrapping="Wrap"
                                VerticalAlignment="Center" VerticalContentAlignment="Top" HorizontalAlignment="Stretch"/>
                    <TextBlock  Grid.Column="0" Grid.Row="2" Text=" Состояние заказа: " VerticalAlignment="Center"/>
                    <TextBlock  Grid.Column="1" Grid.Row="2" Name="OrderStateTextBlock" TextWrapping="Wrap" Text="{Binding Path=CurrentOrder.State, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock  Grid.Column="3" Grid.Row="2" Text=" Дата окончания работ(план): " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                        <TextBlock.InputBindings>
                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateDateCompletion}" MouseAction="LeftClick"/>
                        </TextBlock.InputBindings>
                    </TextBlock>
                    <DatePicker Grid.Column="4" Grid.Row="2" Width="110" VerticalAlignment="Center" HorizontalAlignment="Left" 
                                IsEnabled="{Binding OrderCardDateCompletion}"
                                SelectedDate="{Binding Path=CurrentOrder.DateCompletion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" IsTodayHighlighted="True"/>
                    <TextBlock Grid.Column="0" Grid.Row="3" Text=" Заказ внес в базу: " VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Grid.Row="3" Text="{Binding CurrentOrder.OrderEntered.FullUserName, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="3" Grid.Row="3" Text=" Менеджер: " VerticalAlignment="Center"/>
                    <ComboBox  Grid.Column="4" Grid.Row="3" Name="ManagerComboBox" VerticalAlignment="Center" IsEditable="False"
                               ItemsSource="{Binding ManagerList}" 
                               SelectedValue="{Binding Path=CurrentOrder.ManagerID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"  
                               SelectedValuePath="ID" DisplayMemberPath="FullUserName">
                    </ComboBox>
                </Grid>
            </Border>
        </StackPanel>
        <TabControl Grid.Row="2" Margin="10">
            <TabItem Header="Изделия">
                <Border BorderThickness="1" BorderBrush="DarkBlue">
                    <Grid Margin="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="0,5*"/>
                            <ColumnDefinition Width="0,5*"/>
                        </Grid.ColumnDefinitions>
                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" Name="LabelAndButtonRow"/>
                                <RowDefinition Height="Auto" Name="ListBoxTypeOfProductsRow"/>
                                <RowDefinition Height="*" Name="ListViewProductsRow"/>
                                <RowDefinition Height="Auto" Name="TotalProductsRow"/>
                                <RowDefinition Height="180" Name="DateRow"/>
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="Изделия" FontWeight="Bold" VerticalAlignment="Center"/>
                                <Button Name="NewProductListButton" Background="Transparent" BorderBrush="Transparent" 
                                        Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewProductGrid}"
                                        Style="{StaticResource ButtonOfOrder}" 
                                        Visibility="{Binding ElementName=NewProductGrid, Path=IsVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                        Margin="10,0,0,0" ToolTip="Добавить изделие (показать список)">
                                    <Image Source="/Images/free-icon-add-button.png" Width="20" Height="20"/>
                                </Button>
                                <Button Background="Transparent" BorderBrush="Transparent" 
                                        Visibility="{Binding ElementName=NewProductGrid, Path=Visibility}"
                                        Style="{StaticResource ButtonOfOrder}" Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewProductGrid}"
                                        Margin="10,0,0,0" ToolTip="Свернуть список изделий">
                                    <Image Source="/Images/free-icon-minus-button.png" Width="20" Height="20"/>
                                </Button>
                                <Button Background="Transparent" BorderBrush="Transparent" 
                                        Style="{StaticResource ButtonOfOrder}" Command="{Binding DeleteProduct}" CommandParameter="{Binding ElementName=ListProduct, Path=SelectedItem}"
                                        Margin="0,0,0,0" ToolTip="Отметить изделие для удаления">
                                    <Image Source="/Images/free-icon-bin-Recycler.png" Width="20" Height="20"/>
                                    <Button.IsEnabled>
                                        <MultiBinding Converter="{StaticResource IsCanDeleteAfterSendToProdToBoolConverter}">
                                            <Binding Path="DateTransferProduction" Converter="{StaticResource NullDateTimeToBoolConverter}"/>
                                            <Binding RelativeSource="{RelativeSource AncestorType=local:RequestWindow}" Path="DataContext.OrderCardProductDeleteAfterSetToProd"/>
                                        </MultiBinding>
                                    </Button.IsEnabled>
                                </Button>
                            </StackPanel>
                            <Grid Grid.Row="1" Name="NewProductGrid" Margin="5,0,5,0" Visibility="Collapsed">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <StackPanel Orientation="Horizontal" Margin="0,5,0,5" HorizontalAlignment="Center">
                                    <TextBlock Text="Поиск по наименованию изделия: "/>
                                    <TextBox Text="{Binding Path=SearchTypeOfProduct, UpdateSourceTrigger=PropertyChanged}" Width="300"
                                             ToolTip="Введите фрагмент наименования изделия"/>
                                </StackPanel>
                                <ListBox Grid.Row="1" Name="NewProductListBox" IsSynchronizedWithCurrentItem="true"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"                                     
                                     ItemsSource="{Binding ProductTypeCollectionView, Mode=OneTime}"
                                     DisplayMemberPath="Name">
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="MouseDoubleClick">
                                            <i:InvokeCommandAction Command="{Binding SelectNewProduct}" CommandParameter="{Binding ElementName=NewProductListBox, Path=SelectedItem}"/>
                                            <i:InvokeCommandAction Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewProductGrid}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                    <ListBox.GroupStyle>
                                        <GroupStyle>
                                            <GroupStyle.ContainerStyle>
                                                <Style TargetType="{x:Type GroupItem}">
                                                    <Setter Property="Margin" Value="0,0,0,5"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="{x:Type GroupItem}">
                                                                <Expander Name="GroupProductExpander" BorderBrush="AntiqueWhite" BorderThickness="0,0,0,1"
                                                                          IsHitTestVisible="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ListBoxItem}, Path=IsSelected}" 
                                                                          IsExpanded="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ListBoxItem}, Path=IsSelected}">
                                                                    <Expander.Header>
                                                                        <DockPanel>
                                                                            <TextBlock FontWeight="Bold" Text="{Binding Path=Name}" Margin="5,0,0,0" Width="300"/>
                                                                        </DockPanel>
                                                                    </Expander.Header>
                                                                    <Expander.Content>
                                                                        <ItemsPresenter/>
                                                                    </Expander.Content>
                                                                </Expander>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </GroupStyle.ContainerStyle>
                                        </GroupStyle>
                                    </ListBox.GroupStyle>
                                </ListBox>
                            </Grid>
                            <ListView Grid.Row="2" Name="ListProduct" Margin="5" Padding="2" IsSynchronizedWithCurrentItem="True"
                                      ItemsSource="{Binding CurrentOrder.Products, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                                      PreviewKeyDown="ListViewUpAndDown_PreviewKeyDown">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Path=ProductBlueBorder}" Value="True">
                                                <Setter Property="BorderBrush" Value="Blue"/>
                                                <Setter Property="BorderThickness" Value="3"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Path=ProductRedBorder}" Value="True">
                                                <Setter Property="BorderBrush" Value="Red"/>
                                                <Setter Property="BorderThickness" Value="3"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Path=ProductGreenBorder}" Value="True">
                                                <Setter Property="BorderBrush" Value="Green"/>
                                                <Setter Property="BorderThickness" Value="3"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.View>
                                    <GridView>
                                        <GridView.Columns>
                                            <GridViewColumn x:Name="column1" Header=" Наименование " Width="250"
                                                            DisplayMemberBinding="{Binding Path=ProductType.Name}"
                                                            HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                            <GridViewColumn x:Name="column2" Header=" Кол-во " Width="80" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <TextBox HorizontalContentAlignment="Right" Width="70"
                                                                 Text="{Binding Path=Quantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnValidationError=True, ValidatesOnDataErrors=True}" 
                                                                 Validation.Error="TextBoxError"
                                                                 GotFocus="QuantityTextBox_GotFocus">
                                                            <TextBox.IsEnabled>
                                                                <MultiBinding Converter="{StaticResource IsCanEditAfterSendToProdToBoolConverter}">
                                                                    <Binding Path="DateTransferProduction" Converter="{StaticResource NullDateTimeToBoolConverter}"/>
                                                                    <Binding RelativeSource="{RelativeSource AncestorType=local:RequestWindow}" Path="DataContext.OrderCardProductQuantityAndCost"/>
                                                                </MultiBinding>
                                                            </TextBox.IsEnabled>
                                                        </TextBox>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn x:Name="column3" Header=" Стоимость " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}"
                                                            DisplayMemberBinding="{Binding Path=Cost, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ConverterCulture=ru-RU, StringFormat={}{0:C}}"/>
                                            <GridViewColumn Header=" Дизайнер " Width="200" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox VerticalAlignment="Center" IsEditable="False" Width="190"
                                                                  IsEnabled="{Binding RelativeSource={RelativeSource AncestorType=local:RequestWindow}, Path=DataContext.OrderCardProductDesigner}"
                                                                  ItemsSource="{Binding RelativeSource={RelativeSource AncestorType=local:RequestWindow}, Path=DataContext.DesignerList}" 
                                                                  SelectedValuePath="ID" DisplayMemberPath="FullUserName"
                                                                  SelectedValue="{Binding Path=DesignerID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                                  GotFocus="DesignerComboBox_GotFocus">
                                                        </ComboBox>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header=" Состояние " Width="150" HeaderTemplate="{StaticResource ListViewHeaderTemplate}" 
                                                            DisplayMemberBinding="{Binding Path=State, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        </GridView.Columns>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                            <Border Grid.Row="3" Margin="5,0,5,0" BorderThickness="1" BorderBrush="DodgerBlue">
                                <Grid Margin="2,0,2,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="{Binding ElementName=column1, Path=Width}"/>
                                        <ColumnDefinition Width="{Binding ElementName=column2, Path=Width}"/>
                                        <ColumnDefinition Width="{Binding ElementName=column3, Path=Width}"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Margin="10,0,0,0" Text="ИТОГО:" FontWeight="Bold" Grid.ColumnSpan="2"/>
                                    <TextBlock Grid.Column="1" Margin="0,0,5,0"  Text="{Binding ElementName=ListProduct,Path=Items.Count, UpdateSourceTrigger=PropertyChanged}" HorizontalAlignment="Right" FontWeight="Bold"/>
                                    <TextBlock Grid.Column="2" Margin="7,0,0,0"  Text="{Binding ElementName=ListProduct, Path=ItemsSource, Converter={StaticResource SumListViewDecimalConverter}, ConverterParameter=Cost, StringFormat={}{0:C}, ConverterCulture='ru-RU', UpdateSourceTrigger=PropertyChanged}" 
                                               Name="OrderTotalCosts" HorizontalAlignment="Left" FontWeight="Bold"/>
                                </Grid>
                            </Border>
                            <StackPanel Grid.Row="4">
                                <Label Content="Даты" FontWeight="Bold" HorizontalAlignment="Center"/>
                                <Grid Margin="5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Column="0" Grid.Row="0" Text="Сдать изделие (план): " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateDeliveryPlan}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="1" Grid.Row="0" Name="DateDeliveryPlan" IsEnabled="{Binding OrderCardProductDateProductionLayout}"
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateDeliveryPlan, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                IsTodayHighlighted="True"/>
                                    <TextBlock Grid.Column="0" Grid.Row="1" Text="Сдать макет: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateProductionLayout}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="1" Grid.Row="1" Name="DateProductionLayout" IsEnabled="{Binding OrderCardProductDateTransferDesigner}"
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateProductionLayout, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                IsTodayHighlighted="True"/>
                                    <TextBlock Grid.Column="0" Grid.Row="2" Text="Передано дизайнеру: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateTransferDesigner}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="1" Grid.Row="2" Name="DateTransferDesigner" 
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateTransferDesigner, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                IsTodayHighlighted="True" SourceUpdated="DatePicker_SourceUpdated"/>
                                    <TextBlock Grid.Column="0" Grid.Row="3" Text="Передано на утверждение: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateTransferApproval}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="1" Grid.Row="3" Name="DateTransferApproval" 
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateTransferApproval, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                IsTodayHighlighted="True" SourceUpdated="DatePicker_SourceUpdated"/>
                                    <TextBlock Grid.Column="0" Grid.Row="4" Text="Утверждено: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateApproval}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="1" Grid.Row="4" Name="DateApproval" 
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateApproval, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                IsTodayHighlighted="True" SourceUpdated="DatePicker_SourceUpdated"/>
                                    <TextBlock  Grid.Column="3" Grid.Row="0" Text="Передано в производство: " VerticalAlignment="Center"/>
                                    <TextBlock  Grid.Column="4" Grid.Row="0" Text="{Binding ElementName=ListProduct, Path=SelectedItem.DateTransferProduction, StringFormat=\{0:dd.MM.yyyy\}}" VerticalAlignment="Center"/>
                                    <TextBlock  Grid.Column="3" Grid.Row="1" Text="Изготовлено: " VerticalAlignment="Center"/>
                                    <TextBlock  Grid.Column="4" Grid.Row="1" Text="{Binding ElementName=ListProduct, Path=SelectedItem.DateManufacture, StringFormat=\{0:dd.MM.yyyy\}}" VerticalAlignment="Center"/>
                                    <TextBlock  Grid.Column="3" Grid.Row="2" Text="Отгружено: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                        <TextBlock.InputBindings>
                                            <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateShipment}" MouseAction="LeftClick"/>
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                    <DatePicker Grid.Column="4" Grid.Row="2" Name="DateShipment" 
                                                SelectedDate="{Binding ElementName=ListProduct, Path=SelectedItem.DateShipment, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                IsTodayHighlighted="True" SourceUpdated="DatePicker_SourceUpdated" 
                                                IsEnabled="{Binding ElementName=ListProduct, Path=SelectedItem.DateManufacture, Converter={StaticResource NullDateTimeToBoolConverter}}">
                                    </DatePicker>
                                </Grid>
                            </StackPanel>
                        </Grid>
                        <TabControl Grid.Column="1">
                            <TabItem Header="Описание">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" CanContentScroll="True">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" Name="LabelParametersRow"/>
                                            <RowDefinition Height="Auto" Name="ListViewParametersRow"/>
                                            <RowDefinition Height="Auto" Name="LabelNoteRow"/>
                                            <RowDefinition Height="Auto" Name="TextBoxNoteRow"/>
                                            <RowDefinition Height="Auto" Name="LabelAndButtonFilesRow"/>
                                            <RowDefinition Height="Auto" Name="ListBoxFilesRow"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Grid.Row="0" Text="Параметры" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <ListView Grid.Row="1" Name="ListParametersInProduct" Margin="5" Padding="2" IsSynchronizedWithCurrentItem="True" 
                                                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                  ItemsSource="{Binding ElementName=ListProduct, Path=SelectedItem.ProductParameter}">
                                            <ListView.Resources>
                                                <DataTemplate x:Key="CommonTextBox">
                                                    <TextBox Name="ValueTextBox" HorizontalContentAlignment="Right" Width="90" Language="ru-ru" 
                                                             Text="{Binding Path=ParameterValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                             GotFocus="ValueTextBox_GotFocus" SourceUpdated="ValueTextBox_SourceUpdated">
                                                    </TextBox>
                                                </DataTemplate>
                                                <DataTemplate x:Key="ComboboxTextBox">
                                                    <ComboBox ItemsSource="{Binding Path=ReferencebookParametersList}"
                                                              SelectedValue="{Binding Path=ParameterID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                              SelectedValuePath="ID" DisplayMemberPath="Value"                                                               
                                                              GotFocus="ValueTextBox_GotFocus" MinWidth="90" SourceUpdated="ValueTextBox_SourceUpdated">
                                                    </ComboBox>
                                                </DataTemplate>
                                                <DataTemplate x:Key="CommonTextBlock">
                                                    <TextBlock Text="" Width="90"/>
                                                </DataTemplate>
                                                <DataTemplate x:Key="ComboboxRefbookRequestTextBox">
                                                    <ComboBox ItemsSource="{Binding Path=ReferencebookList}" Name="ReferencebookList" ToolTip="Справочник по выбору"
                                                              SelectedValue="{Binding Path=ReferencebookID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                              SelectedValuePath="ID" DisplayMemberPath="Name" SelectionChanged="ComboBox_SelectionChanged"
                                                              GotFocus="ValueTextBox_GotFocus" Width="90" SourceUpdated="ValueTextBox_SourceUpdated">
                                                    </ComboBox>
                                                </DataTemplate>
                                            </ListView.Resources>
                                            <ListView.View>
                                                <GridView>
                                                    <GridView.Columns>
                                                        <GridViewColumn Header=" параметр " Width="250" DisplayMemberBinding="{Binding Path=Name}" HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                                        <GridViewColumn Header="">
                                                            <GridViewColumn.CellTemplateSelector>
                                                                <local:ReferencebookTemplateSelector
                                                                    CommonTextBlock="{StaticResource CommonTextBlock}" 
                                                                    ComboboxRefbookRequestTextBox="{StaticResource ComboboxRefbookRequestTextBox}"/>
                                                            </GridViewColumn.CellTemplateSelector>
                                                        </GridViewColumn>
                                                        <GridViewColumn Header=" значение " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                            <GridViewColumn.CellTemplateSelector>
                                                                <local:CostTemplateSelector 
                                                                    CommonTextBox="{StaticResource CommonTextBox}" 
                                                                    ComboboxTextBox="{StaticResource ComboboxTextBox}"/>
                                                            </GridViewColumn.CellTemplateSelector>
                                                        </GridViewColumn>
                                                        <GridViewColumn Header=" ед. изи. " Width="60" DisplayMemberBinding="{Binding Path=UnitName}" HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                                        <GridViewColumn Header=" обязательный " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                            <GridViewColumn.CellTemplate>
                                                                <DataTemplate>
                                                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                                                                        <CheckBox IsHitTestVisible="False" HorizontalAlignment="Right" IsChecked="{Binding Path=IsRequired}" IsTabStop="False"/>
                                                                    </StackPanel>
                                                                </DataTemplate>
                                                            </GridViewColumn.CellTemplate>
                                                        </GridViewColumn>
                                                    </GridView.Columns>
                                                </GridView>
                                            </ListView.View>
                                        </ListView>
                                        <TextBlock Grid.Row="2" Text="Описание изделия" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <TextBox Grid.Row="3" Margin="5" Text="{Binding ElementName=ListProduct, Path=SelectedItem.Note}" 
                                                 MinHeight="50" AcceptsReturn="True" TextWrapping="Wrap" HorizontalContentAlignment="Left" VerticalContentAlignment="Top"/>
                                        <StackPanel Grid.Row="4" Margin="5" Orientation="Horizontal" HorizontalAlignment="Center">
                                            <TextBlock Text="Файлы и иллюстрации" FontWeight="Bold" HorizontalAlignment="Stretch" VerticalAlignment="Center"/>
                                            <Button Name="NewFileButton" Background="Transparent" BorderBrush="Transparent" 
                                                    Style="{StaticResource ButtonOfOrder}" Command="{Binding NewFileToProduct}" CommandParameter="{Binding ElementName=ListProduct, Path=SelectedItem}"
                                                    Margin="10,0,0,0" ToolTip="Добавить файл">
                                                <Image Source="/Images/free-icon-add-button.png" Width="20" Height="20"/>
                                            </Button>
                                            <Button Name="DeleteFileButton" Background="Transparent" BorderBrush="Transparent" 
                                                    Style="{StaticResource ButtonOfOrder}" Command="{Binding DeleteFileFromProduct}"
                                                    ToolTip="Удалить файл из списка и отметить для удаления">
                                                <Image Source="/Images/free-icon-bin-Recycler.png" Width="20" Height="20"/>
                                                <Button.CommandParameter>
                                                    <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                        <Binding ElementName="ListProduct" Path="SelectedItem"/>
                                                        <Binding ElementName="FilesListBox" Path="SelectedItem"/>
                                                    </MultiBinding>
                                                </Button.CommandParameter>
                                            </Button>
                                            <Button Name="OpenFolderButton" Background="Transparent" BorderBrush="Transparent" 
                                                    Style="{StaticResource ButtonOfOrder}" Command="{Binding OpenFolderWithFileProduct}"
                                                    ToolTip="Открыть папку с файлами">
                                                <Image Source="/Images/free-icon-folder_open.png" Width="20" Height="20"/>
                                            </Button>
                                        </StackPanel>
                                        <ListBox Grid.Row="5" Margin="5" Name="FilesListBox" 
                                                 ScrollViewer.VerticalScrollBarVisibility="Auto" MinHeight="80" 
                                                 IsSynchronizedWithCurrentItem="True"
                                                 ToolTip="Двойной щелчок - открыть файл во внешней программе"
                                                 ItemsSource="{Binding ElementName=ListProduct, Path=SelectedItem.FilesList, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}">
                                            <i:Interaction.Triggers>
                                                <i:EventTrigger EventName="MouseDoubleClick">
                                                    <i:InvokeCommandAction Command="{Binding OpenFileProductInShell}" CommandParameter="{Binding ElementName=FilesListBox, Path=SelectedItem}"/>
                                                </i:EventTrigger>
                                            </i:Interaction.Triggers>
                                        </ListBox>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>
                            <TabItem Header="Стоимость и затраты по КВД">
                                <StackPanel>
                                    <ListView Name="CostOfProduct" Margin="5" Padding="2" IsSynchronizedWithCurrentItem="True" 
                                              ItemsSource="{Binding ElementName=ListProduct, Path=SelectedItem.ProductCosts}" PreviewKeyDown="ListViewUpAndDown_PreviewKeyDown">
                                        <ListView.View>
                                            <GridView>
                                                <GridViewColumn Header=" Код " Width="Auto" HeaderTemplate="{StaticResource ListViewHeaderTemplate}"
                                                        DisplayMemberBinding="{Binding Path=Code}"/>
                                                <GridViewColumn Header=" Вид деятельности " Width="Auto" HeaderTemplate="{StaticResource ListViewHeaderTemplate}"
                                                        DisplayMemberBinding="{Binding Path=Name}"/>
                                                <GridViewColumn Header=" Стоимость " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                    <GridViewColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <TextBox Name="TypeOfActivityCostTextBox" Style="{StaticResource ValidationTemplate}"
                                                                     HorizontalContentAlignment="Right" Width="90" Language="ru-RU"                                                                     
                                                                     Validation.Error="TextBoxError"
                                                                     SourceUpdated="TypeOfActivityCostTextBox_SourceUpdated"
                                                                     GotFocus="TypeOfActivityCostTextBox_GotFocus">
                                                                <TextBox.Text>
                                                                    <Binding Path="Cost" Mode="TwoWay" UpdateSourceTrigger="LostFocus"
                                                                             NotifyOnSourceUpdated="True" 
                                                                             ValidatesOnNotifyDataErrors="True" NotifyOnValidationError="True" 
                                                                             Converter="{StaticResource CostConverter}">
                                                                        <Binding.ValidationRules>
                                                                            <local:CostValidationRule/>
                                                                        </Binding.ValidationRules>
                                                                    </Binding>
                                                                </TextBox.Text>
                                                                <TextBox.IsEnabled>
                                                                    <MultiBinding Converter="{StaticResource IsCanEditAfterSendToProdToBoolConverter}">
                                                                        <Binding Path="DateTransferProduction" Converter="{StaticResource NullDateTimeToBoolConverter}"/>
                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:RequestWindow}" Path="DataContext.OrderCardProductQuantityAndCost"/>
                                                                    </MultiBinding>
                                                                </TextBox.IsEnabled>
                                                            </TextBox>
                                                        </DataTemplate>
                                                    </GridViewColumn.CellTemplate>
                                                </GridViewColumn>
                                                <GridViewColumn Header=" Затраты " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                    <GridViewColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <TextBox Name="TypeOfActivityOutlayTextBox" Style="{StaticResource ValidationTemplate}"
                                                                     HorizontalContentAlignment="Right" Width="90" Language="ru-RU"
                                                                     IsEnabled="{Binding Path=ProductCostAndCostsKVDCostsChange}"
                                                                     Validation.Error="TextBoxError"
                                                                     SourceUpdated="TypeOfActivityCostTextBox_SourceUpdated"
                                                                     GotFocus="TypeOfActivityCostTextBox_GotFocus">
                                                                <TextBox.Text>
                                                                    <Binding Path="Outlay" Mode="TwoWay" UpdateSourceTrigger="LostFocus"
                                                                     NotifyOnSourceUpdated="True" 
                                                                     ValidatesOnNotifyDataErrors="True" NotifyOnValidationError="True" 
                                                                     Converter="{StaticResource CostConverter}">
                                                                        <Binding.ValidationRules>
                                                                            <local:CostValidationRule/>
                                                                        </Binding.ValidationRules>
                                                                    </Binding>
                                                                </TextBox.Text>
                                                            </TextBox>
                                                        </DataTemplate>
                                                    </GridViewColumn.CellTemplate>
                                                </GridViewColumn>
                                            </GridView>
                                        </ListView.View>
                                    </ListView>
                                </StackPanel>
                            </TabItem>
                            <TabItem Header="Тех.карта">
                                <Border Margin="2" BorderThickness="1" BorderBrush="DarkBlue">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="0.5*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*" Name="Row_Tree"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <WrapPanel Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="2" Margin="3" Orientation="Horizontal">
                                            <Button Name="LoadTechCardButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding LoadTechCard}"
                                                    ToolTip="Загрузить техкарты из БД">
                                                <StackPanel Orientation="Horizontal">
                                                    <Image Source="\Images\premium-icon-download.png" Width="25" Height="25"/>
                                                    <Label Content="Загрузить"/>
                                                </StackPanel>
                                            </Button>
                                            <Separator/>
                                            <Button Name="SaveTechCardButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding SaveTechCard}"
                                                    ToolTip="Сохранить данные по техкартам в БД">
                                                <StackPanel Orientation="Horizontal">
                                                    <Image Source="\Images\free-icon-floppy-disk_save.png" Width="25" Height="25"/>
                                                    <Label Content="Сохранить"/>
                                                </StackPanel>
                                            </Button>
                                            <Separator/>
                                            <Border BorderThickness="0.7" BorderBrush="Black" Margin="2">
                                                <WrapPanel Orientation="Horizontal">
                                                    <TextBlock Text=" Добавить => " VerticalAlignment="Center"/>
                                                    <WrapPanel Orientation="Horizontal">
                                                        <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding NewTechCard}" ToolTip="Техкарта">
                                                            <Image Source="\Images\free-icon-techcard.png" Width="25" Height="25"/>
                                                        </Button>
                                                        <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding NewTechCardWork}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}" ToolTip="Работа">
                                                            <Image Source="\Images\free-icon-techcard_work.png" Width="25" Height="25"/>
                                                        </Button>
                                                        <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding NewTechCardWorkOperation}" CommandParameter="{Binding ElementName=TechCardTreeView,Path=SelectedItem}" ToolTip="Операция (скрыть/отобразить список операций)">
                                                            <Image Source="\Images\free-icon-techcard_operation.png" Width="25" Height="25"/>
                                                            <i:Interaction.Triggers>
                                                                <i:EventTrigger EventName="Click">
                                                                    <i:InvokeCommandAction Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewOperationListBox}"/>
                                                                    <i:ChangePropertyAction TargetObject="{Binding ElementName=NewOperationListBoxRow}" PropertyName="Height" Value="Auto"/>
                                                                </i:EventTrigger>
                                                            </i:Interaction.Triggers>
                                                        </Button>
                                                        <!--<Button Style="{StaticResource ButtonOfOrder}" Background="Transparent" BorderBrush="Transparent"
                                                                ToolTip="Свернуть список операций" HorizontalAlignment="Right"                                                                 
                                                                Visibility="{Binding ElementName=NewOperationListBox, Path=Visibility}">
                                                            <Image Source="/Images/free-icon-minus-button.png" Width="25" Height="25"/>
                                                            <i:Interaction.Triggers>
                                                                <i:EventTrigger EventName="MouseLeftButtonClick">
                                                                    <i:InvokeCommandAction Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewOperationListBox}"/>
                                                                    <i:ChangePropertyAction TargetObject="{Binding ElementName=NewOperationListBoxRow}" PropertyName="Height" Value="Auto"/>
                                                                </i:EventTrigger>
                                                            </i:Interaction.Triggers>
                                                        </Button>-->
                                                    </WrapPanel>
                                                </WrapPanel>
                                            </Border>
                                            <Separator/>
                                            <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding SendTechCardToProduction}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}" ToolTip="Передать техкарту в производство">
                                                <StackPanel Orientation="Horizontal">
                                                    <Image Source="\Images\free-icon-factory.png" Width="25" Height="25"/>
                                                    <Label Content="В производство"/>
                                                </StackPanel>
                                            </Button>
                                            <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding RecallTechCardFromProduction}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}" ToolTip="Отозвать техкарту с производства">
                                                <StackPanel Orientation="Horizontal">
                                                    <Image Source="\Images\free-icon-back.png" Width="25" Height="25"/>
                                                    <Label Content="Отозвать"/>
                                                </StackPanel>
                                            </Button>
                                            <Separator/>
                                            <Button Name="SendTechCardToPrint" Style="{StaticResource ButtonOfOrder}" Command="{Binding PrintTechCard}" ToolTip="Печать техкарты или ее части">
                                                <StackPanel Orientation="Horizontal">
                                                    <Image Source="\Images\free-icon-printer-techcard.png" Width="25" Height="25"/>
                                                    <Label Content="Печать"/>
                                                </StackPanel>
                                                <Button.ContextMenu>
                                                    <ContextMenu Visibility="Hidden">
                                                    </ContextMenu>
                                                </Button.ContextMenu>
                                                <Button.CommandParameter>
                                                    <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                        <Binding ElementName="SendTechCardToPrint"/>
                                                        <Binding ElementName="TechCardTreeView" Path="SelectedItem"/>
                                                    </MultiBinding>
                                                </Button.CommandParameter>
                                            </Button>
                                        </WrapPanel>
                                        <TreeView Grid.Column="0" Grid.Row="1" Margin="2" Name="TechCardTreeView" BorderThickness="1" BorderBrush="DodgerBlue" 
                                                  ScrollViewer.CanContentScroll="True" ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                  ItemsSource="{Binding ListTechCard}"
                                                  SelectedItemChanged="TechCardTreeView_SelectedItemChanged">
                                            <TreeView.InputBindings>
                                                <KeyBinding Key="Delete" Command="{Binding DeleteTechCard}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}"/>
                                            </TreeView.InputBindings>
                                            <TreeView.Resources>
                                                <HierarchicalDataTemplate DataType="{x:Type model:TechCard}" ItemsSource="{Binding Path=WorkInTechCards}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="√ " VerticalAlignment="Center" Visibility="{Binding IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}" FontWeight="ExtraBold"/>
                                                        <TextBlock Text="{Binding Path=Product.ProductTypeName}" Padding="2" VerticalAlignment="Center" MouseLeftButtonDown="TechCardTreeView_MouseLeftButtonDown"
                                                                   ToolTip="Ctrl+левая кнопка мыши - отметить/снять отметку"/>
                                                    </StackPanel>
                                                </HierarchicalDataTemplate>
                                                <HierarchicalDataTemplate DataType="{x:Type model:WorkInTechCard}" ItemsSource="{Binding Path=OperationInWorks}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="√ " VerticalAlignment="Center" Visibility="{Binding IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}" FontWeight="ExtraBlack"/>
                                                        <StackPanel Orientation="Vertical">
                                                            <TextBlock Name="WorkInTechCardTextBlock" Text="{Binding Path=TypeOfActivity_CodeName}" Padding="2"                                                                        
                                                                       ToolTip="Двойным щелчок мышью изменить, если нет операций.&#x0a;Ctrl+левая кнопка мыши - отметить/снять отметку"
                                                                       Visibility="{Binding ElementName=WorkInTechCardComboBox, Path=IsVisible, Converter={StaticResource BoolToVisibilityConverter}, UpdateSourceTrigger=PropertyChanged}"
                                                                       VerticalAlignment="Center" MouseLeftButtonDown="WorkInTechCardTextBlock_MouseLeftButtonDown">
                                                            </TextBlock>
                                                            <ComboBox Padding="2" Name="WorkInTechCardComboBox" ItemsSource="{Binding Source={StaticResource CommonList}, Path=ListTypeOfActivity}" 
                                                                      VerticalAlignment="Center" ScrollViewer.CanContentScroll="True" ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                                      Visibility="{Binding ElementName=WorkInTechCardTextBlock, Path=IsVisible, Converter={StaticResource BoolToVisibilityConverter}, UpdateSourceTrigger=PropertyChanged}"
                                                                      SelectedValuePath="ID" DisplayMemberPath="CodeName"
                                                                      SelectedValue="{Binding Path=TypeOfActivityID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                                      SelectionChanged="WorkTypeOfActivityComboBox_SelectionChanged" 
                                                                      GotFocus="WorkTypeOfActivityComboBox_GotFocus" 
                                                                      DropDownClosed="WorkInTechCardComboBox_DropDownClosed"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                    <HierarchicalDataTemplate.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding Path=Operation.Name}" Name="OperationInWorkTextBlock" Padding="2"/>
                                                        </DataTemplate>
                                                    </HierarchicalDataTemplate.ItemTemplate>
                                                </HierarchicalDataTemplate>
                                            </TreeView.Resources>
                                            <TreeView.ItemContainerStyle>
                                                <!--BasedOn="{StaticResource SpecialTreeViewItem}"-->
                                                <Style TargetType="TreeViewItem">
                                                    <Setter Property="IsSelected" Value="{Binding Path=IsSelected, Mode=TwoWay}"/>
                                                    <Setter Property="IsExpanded" Value="{Binding Path=IsExpanded, Mode=TwoWay}"/>
                                                </Style>
                                            </TreeView.ItemContainerStyle>
                                        </TreeView>
                                        <Grid Grid.Column="1" Grid.Row="1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" Name="NewOperationListBoxRow"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <ListBox Grid.Column="0" Grid.Row="0" Grid.RowSpan="5" Name="NewOperationListBox" Visibility="Collapsed"
                                                     ScrollViewer.VerticalScrollBarVisibility="Auto" IsSynchronizedWithCurrentItem="true"
                                                     ItemsSource="{Binding OperationCollectionView, Mode=OneTime}"
                                                     DisplayMemberPath="Name" ToolTip="Двойным кликом выбрать операцию">
                                                <i:Interaction.Triggers>
                                                    <i:EventTrigger EventName="MouseDoubleClick">
                                                        <i:InvokeCommandAction Command="{Binding ShowHideFrameworkElement}" CommandParameter="{Binding ElementName=NewOperationListBox}"/>
                                                        <i:ChangePropertyAction TargetObject="{Binding ElementName=NewOperationListBoxRow}" PropertyName="Height" Value="Auto"/>
                                                        <i:InvokeCommandAction Command="{Binding SelectNewOperation}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}"/>
                                                    </i:EventTrigger>
                                                </i:Interaction.Triggers>
                                            </ListBox>
                                            <StackPanel Grid.Column="1" Grid.Row="0" Grid.ColumnSpan="2" Orientation="Vertical" ScrollViewer.CanContentScroll="True"
                                                        Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=NoteTechCardStackPanel}">
                                                <TextBlock Text="Описание" VerticalAlignment="Center"/>
                                                <TextBox MinHeight="70" BorderThickness="1" BorderBrush="Black" ScrollViewer.HorizontalScrollBarVisibility="Auto" ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                         Text="{Binding ElementName=TechCardTreeView, Path=SelectedItem.Note, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                         AcceptsReturn="True" TextWrapping="Wrap" HorizontalContentAlignment="Left" VerticalContentAlignment="Top" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2" Orientation="Vertical" 
                                                        Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=WorkInTechCardAttribute}">
                                                <TextBlock Text="Название работы" VerticalAlignment="Center"/>
                                                <TextBox MinHeight="70" BorderThickness="1" BorderBrush="Black" Margin="0,0,2,0" ScrollViewer.HorizontalScrollBarVisibility="Auto" ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                         Text="{Binding ElementName=TechCardTreeView, Path=SelectedItem.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                         AcceptsReturn="True" TextWrapping="Wrap" HorizontalContentAlignment="Left" VerticalContentAlignment="Top" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="1" Grid.Row="2" Text=" Дата планового завершения работы: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center"
                                                       Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=WorkInTechCardAttribute}">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DatePlanCompletion}" MouseAction="LeftClick"/>
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                            <DatePicker Grid.Column="2" Grid.Row="2" Name="DatePlanCompletion" IsTodayHighlighted="True"
                                                        Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=WorkInTechCardAttribute}" 
                                                        SelectedDate="{Binding ElementName=TechCardTreeView, Path=SelectedItem.DatePlanCompletion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                            <TextBlock Grid.Column="1" Grid.Row="3" Text=" Дата фактического завершения работы: " VerticalAlignment="Center" 
                                                       Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=WorkInTechCardAttribute}"
                                                       Style="{StaticResource UnderlineTextBlock}">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DateFactCompletion}" MouseAction="LeftClick"/>
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                            <DatePicker Grid.Column="2" Grid.Row="3" Name="DateFactCompletion" IsTodayHighlighted="True"
                                                        Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=WorkInTechCardAttribute}" 
                                                        SelectedDate="{Binding ElementName=TechCardTreeView, Path=SelectedItem.DateFactCompletion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}"  
                                                        SourceUpdated="DateFactCompletion_SourceUpdated"/>
                                            <Grid Grid.Column="1" Grid.Row="4" Grid.ColumnSpan="2" Margin="2"
                                                  Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=OperationInWorkAttribute}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*" Name="Col_Note"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text=" Производственный участок  "/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ElementName=TechCardTreeView, Path=SelectedItem.Operation.ProductionArea.Name}"/>
                                                <TextBlock Grid.Row="1" Grid.Column="0" Text=" Описание" Margin="0,5,0,0" VerticalAlignment="Center"/>
                                                <TextBox Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,5,0,0" 
                                                         BorderThickness="1" BorderBrush="Black" AcceptsReturn="True" TextWrapping="Wrap"
                                                         ScrollViewer.VerticalScrollBarVisibility="Auto" 
                                                         MaxHeight="180"
                                                         Text="{Binding ElementName=TechCardTreeView, Path=SelectedItem.Note, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                                <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,5,0,0" Orientation="Horizontal" HorizontalAlignment="Left">
                                                    <TextBlock Text=" Файлы и иллюстрации" VerticalAlignment="Center"/>
                                                    <Button Background="Transparent" BorderBrush="Transparent" 
                                                                Style="{StaticResource ButtonOfOrder}" Command="{Binding NewOperationInWorkFile}" CommandParameter="{Binding ElementName=TechCardTreeView, Path=SelectedItem}"
                                                                Margin="5,0,0,0" ToolTip="Добавить файл">
                                                        <Image Source="/Images/free-icon-add-button.png" Width="20" Height="20"/>
                                                    </Button>
                                                    <Button Background="Transparent" BorderBrush="Transparent" 
                                                                Style="{StaticResource ButtonOfOrder}" Command="{Binding DeleteOperationInWorkFile}"
                                                                ToolTip="Удалить файл из списка и отметить для удаления">
                                                        <Image Source="/Images/free-icon-bin-Recycler.png" Width="20" Height="20"/>
                                                        <Button.CommandParameter>
                                                            <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                                <Binding ElementName="TechCardTreeView" Path="SelectedItem"/>
                                                                <Binding ElementName="OperationInWorkFilesListBox" Path="SelectedItem"/>
                                                            </MultiBinding>
                                                        </Button.CommandParameter>
                                                    </Button>
                                                </StackPanel>
                                                <ListBox Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" Name="OperationInWorkFilesListBox" BorderThickness="1" BorderBrush="Black"
                                                         ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                                         ToolTip="Двойной щелчок - открыть файл во внешней программе"
                                                         VerticalAlignment="Bottom" Height="90"
                                                         ItemsSource="{Binding ElementName=TechCardTreeView, Path=SelectedItem.FilesList, Mode=OneWay}">
                                                    <i:Interaction.Triggers>
                                                        <i:EventTrigger EventName="MouseDoubleClick">
                                                            <i:InvokeCommandAction Command="{Binding OpenOperationInWorkFile}" CommandParameter="{Binding ElementName=OperationInWorkFilesListBox, Path=SelectedItem}"/>
                                                        </i:EventTrigger>
                                                    </i:Interaction.Triggers>
                                                </ListBox>
                                            </Grid>
                                        </Grid>
                                        <ListView Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="3" Name="ListOperationInWorkParameters" Margin="2" Padding="1"
                                                  ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"                                                  
                                                  Visibility="{Binding ElementName=TechCardTreeView, Path=SelectedItem, Converter={StaticResource VisibilitySelector}, ConverterParameter=OperationInWorkAttribute}"
                                                  ItemsSource="{Binding ElementName=TechCardTreeView, Path=SelectedItem.OperationInWorkParameters}">
                                            <ListView.Resources>
                                                <DataTemplate x:Key="CommonTextBox">
                                                    <TextBox Name="ValueTextBox" HorizontalContentAlignment="Right" Width="90" Language="ru-ru"    
                                                             Text="{Binding Path=ParameterValue, Mode=TwoWay, 
                                                                    UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                             SourceUpdated="OperationParameterTextBox_SourceUpdated" 
                                                             GotFocus="OperationParameterTextBox_GotFocus">
                                                    </TextBox>
                                                </DataTemplate>
                                                <DataTemplate x:Key="ComboboxTextBox">
                                                    <ComboBox ItemsSource="{Binding Path=ReferencebookParametersList}"
                                                              SelectedValue="{Binding Path=ParameterID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                              SelectedValuePath="ID" DisplayMemberPath="Value" 
                                                              SourceUpdated="OperationParameterTextBox_SourceUpdated"
                                                              SelectionChanged="OperationParameterValueComboBox_SelectionChanged"
                                                              GotFocus="OperationParameterTextBox_GotFocus" MinWidth="90">
                                                    </ComboBox>
                                                </DataTemplate>
                                                <DataTemplate x:Key="CommonTextBlock">
                                                    <TextBlock Text="" Width="90"/>
                                                </DataTemplate>
                                                <DataTemplate x:Key="ComboboxRefbookRequestTextBox">
                                                    <ComboBox ItemsSource="{Binding Path=ReferencebookList}" ToolTip="Справочник по выбору"
                                                              SelectedValue="{Binding Path=ReferencebookID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                                              SelectedValuePath="ID" DisplayMemberPath="Name" 
                                                              SelectionChanged="OperationParameterComboBox_SelectionChanged"
                                                              SourceUpdated="OperationParameterTextBox_SourceUpdated" 
                                                              GotFocus="OperationParameterTextBox_GotFocus" Width="90">
                                                    </ComboBox>
                                                </DataTemplate>
                                            </ListView.Resources>
                                            <ListView.View>
                                                <GridView>
                                                    <GridView.Columns>
                                                        <GridViewColumn Header=" параметр " Width="250" DisplayMemberBinding="{Binding Path=Name}"
                                                                        HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                                        <GridViewColumn Header="">
                                                            <GridViewColumn.CellTemplateSelector>
                                                                <local:ReferencebookTemplateSelector
                                                                CommonTextBlock="{StaticResource CommonTextBlock}" 
                                                                ComboboxRefbookRequestTextBox="{StaticResource ComboboxRefbookRequestTextBox}"/>
                                                            </GridViewColumn.CellTemplateSelector>
                                                        </GridViewColumn>
                                                        <GridViewColumn Header=" значение " Width="100" HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                                            <GridViewColumn.CellTemplateSelector>
                                                                <local:CostTemplateSelector 
                                                                CommonTextBox="{StaticResource CommonTextBox}" 
                                                                ComboboxTextBox="{StaticResource ComboboxTextBox}"/>
                                                            </GridViewColumn.CellTemplateSelector>
                                                        </GridViewColumn>
                                                        <GridViewColumn Header=" ед. изи. " Width="60" 
                                                                        HeaderTemplate="{StaticResource ListViewHeaderTemplate}"
                                                                        DisplayMemberBinding="{Binding Path=UnitName}"/>
                                                    </GridView.Columns>
                                                </GridView>
                                            </ListView.View>
                                        </ListView>
                                    </Grid>
                                </Border>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </Border>
            </TabItem>
            <TabItem Header="Платежи">
                <Border Margin="2" BorderThickness="1" BorderBrush="DarkBlue">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="305*"/>
                            <ColumnDefinition Width="731*"/>
                            <!--список платежей-->
                            <ColumnDefinition Width="Auto"/>
                            <!--поля для редактирования-->
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <!--кнопки управлениня платежами-->
                            <RowDefinition Height="Auto"/>
                            <!--список платежей-->
                            <RowDefinition Height="Auto"/>
                            <!--ИТОГО платежей-->
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="3" Margin="2,2,2,2" Orientation="Horizontal">
                            <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding SavePayment}"
                                            ToolTip="Сохранить данные по платежам в БД">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\free-icon-floppy-disk_save.png" Width="25" Height="25"/>
                                    <Label Content="Сохранить"/>
                                </StackPanel>
                            </Button>
                            <Separator/>
                            <Button Style="{StaticResource ButtonOfOrder}" Command="{Binding NewPayment}">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\premium-icon-payment.png" Width="25" Height="25"/>
                                    <Label Content="Новый платеж"/>
                                </StackPanel>
                            </Button>
                        </WrapPanel>
                        <ListView Grid.Column="0" Grid.Row="1" Name="ListPayments" Margin="3,3,3,3" Padding="2"
                                  ItemsSource="{Binding ListPayment, UpdateSourceTrigger=PropertyChanged}" KeyDown="ListPayments_KeyDown"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto" HorizontalContentAlignment="Stretch" Grid.ColumnSpan="2">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn x:Name="_paycol0" Header=" Счёт " DisplayMemberBinding="{Binding Path=Account.AccountNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="150"/>
                                    <GridViewColumn x:Name="_paycol1" Header=" Дата платежа " DisplayMemberBinding="{Binding Path=PaymentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ConverterCulture=ru-RU, StringFormat=\{0:dd.MM.yyyy\}}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                    <GridViewColumn Header=" Сумма платежа "
                                                    DisplayMemberBinding="{Binding Path=PaymentAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                    <GridViewColumn Header=" Квитанция/П.п. " DisplayMemberBinding="{Binding Path=PaymentDocNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                    <GridViewColumn Header=" Назначение платежа " DisplayMemberBinding="{Binding Path=PurposeOfPaymentName, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="200"/>
                                    <GridViewColumn Header=" Вид платежа " DisplayMemberBinding="{Binding Path=TypeOfPaymentName, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                        <Border Grid.Column="0" Grid.Row="2" Margin="3,3,3,3" BorderBrush="Black" BorderThickness="0.5" Grid.ColumnSpan="2">
                            <Grid >
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="{Binding ElementName=_paycol0, Path=ActualWidth}"/>
                                    <ColumnDefinition Width="{Binding ElementName=_paycol1, Path=ActualWidth}"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="1" Text=" Оплачено:" Margin="2" HorizontalAlignment="Right" VerticalAlignment="Center" FontWeight="Bold"/>
                                <TextBlock Grid.Column="2" Margin="10,0,0,0" Name="TotalPaymentsTextBlock" Text="{Binding ElementName=ListPayments, Path=ItemsSource, 
                                           Converter={StaticResource SumListViewDecimalConverter}, ConverterParameter=PaymentAmount, StringFormat={}{0:C}, ConverterCulture='ru-RU'}" 
                                           HorizontalAlignment="Left" VerticalAlignment="Center" FontWeight="Bold"/>
                            </Grid>
                        </Border>
                        <Grid Grid.Column="2" Grid.Row="1" Margin="2,2,5,2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="20"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Column="0" Grid.Row="1" Text="Платеж по счету: " VerticalAlignment="Center"/>
                            <ComboBox  Grid.Column="1" Grid.Row="1" Margin="2" Name="AccountsListComboBox" Width="200"
                                       ItemsSource="{Binding AccountForPayment}" SelectionChanged="AccountsListComboBox_SelectionChanged"
                                       SelectedValuePath="ID" DisplayMemberPath="AccountNumber"
                                       SelectedValue="{Binding ElementName=ListPayments, Path=SelectedItem.AccountID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <TextBlock Grid.Column="0" Grid.Row="2" Name="PaymentDateLabel" Text="Дата платежа: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                <TextBlock.InputBindings>
                                    <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DatePayment}" MouseAction="LeftClick"/>
                                </TextBlock.InputBindings>
                            </TextBlock>
                            <DatePicker Grid.Column="1" Grid.Row="2"  Margin="2"  Name="DatePayment" 
                                        SelectedDate="{Binding ElementName=ListPayments, Path=SelectedItem.PaymentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                        IsTodayHighlighted="True"/>
                            <TextBlock Grid.Column="0" Grid.Row="3" Text="Сумма платежа: " VerticalAlignment="Center"/>
                            <TextBox Grid.Column="1" Grid.Row="3"  Margin="2" SourceUpdated="PaymentAmountTextBox_SourceUpdated"
                                     Validation.Error="TextBoxError"
                                     Text="{Binding ElementName=ListPayments, NotifyOnSourceUpdated=True, NotifyOnValidationError=True,
                                     Path=SelectedItem.PaymentAmount, Mode=TwoWay, UpdateSourceTrigger=LostFocus, ConverterCulture=ru-RU, StringFormat={}{0:C}}"/>
                            <TextBlock Grid.Column="0" Grid.Row="4" Text="Квитанция/П.п.: " VerticalAlignment="Center"/>
                            <TextBox Grid.Column="1" Grid.Row="4"  Margin="2"  Width="200"
                                     Text="{Binding ElementName=ListPayments, Path=SelectedItem.PaymentDocNumber, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged }"/>
                            <TextBlock Grid.Column="0" Grid.Row="5" Text="Назначение платежа: "  VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" Grid.Row="5" Margin="2" 
                                      ItemsSource="{Binding ElementName=ListPayments, Path=SelectedItem.ListPurposeOfPayment}"
                                      SelectedIndex="{Binding ElementName=ListPayments, Path=SelectedItem.PurposeOfPayment, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <TextBlock Grid.Column="0" Grid.Row="6" Text="Вид платежа: "  VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="1" Grid.Row="6"  Margin="2" 
                                      ItemsSource="{Binding ElementName=ListPayments, Path=SelectedItem.ListTypeOfPayment}"
                                      SelectedIndex="{Binding ElementName=ListPayments, Path=SelectedItem.TypeOfPayment, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </Grid>
                    </Grid>
                </Border>
            </TabItem>
            <TabItem Header="Стоимость и затраты по КВД">
                <Border Margin="2" BorderThickness="1" BorderBrush="DarkBlue">
                    <ListView Margin="5" Padding="2" IsSynchronizedWithCurrentItem="True" ItemsSource="{Binding TotalProductCosts}">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header=" Код " DisplayMemberBinding="{Binding Path=Code}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                <GridViewColumn Header=" Наименование " DisplayMemberBinding="{Binding Path=Name}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="200"/>
                                <GridViewColumn Header=" Стоимость "
                                                DisplayMemberBinding="{Binding Path=Cost, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                <GridViewColumn Header=" Затраы "
                                                DisplayMemberBinding="{Binding Path=Outlay, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                <GridViewColumn Header=" Маржа "
                                                DisplayMemberBinding="{Binding Path=Margin, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </Border>
            </TabItem>
            <TabItem Header="ПУДы">
                <Border Margin="2" BorderThickness="1" BorderBrush="DarkBlue">
                    <Grid Name="PADGrid" Grid.IsSharedSizeScope="True">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="0,45*"/>
                            <ColumnDefinition Width="0,55*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <!--кнопки-->
                            <RowDefinition Height="Auto"/>
                            <!--надпись СЧЕТА-->
                            <RowDefinition Height="Auto"/>
                            <!--счета-->
                            <RowDefinition Height="0,5*"/>
                            <!--надпись АКТЫ-->
                            <RowDefinition Height="Auto"/>
                            <!--акты-->
                            <RowDefinition Height="0,5*"/>
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal">
                            <Button Name="LoadPADButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding LoadAccount}"
                                    ToolTip="Загрузить ПУДы из БД">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\premium-icon-download.png" Width="25" Height="25"/>
                                    <Label Content="Загрузить"/>
                                </StackPanel>
                            </Button>
                            <Separator/>
                            <Button Name="SavePADButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding SaveAccount}"
                                    ToolTip="Сохранить данные по ПУДам в БД">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\free-icon-floppy-disk_save.png" Width="25" Height="25"/>
                                    <Label Content="Сохранить"/>
                                </StackPanel>
                            </Button>
                            <Separator/>
                            <Button Name="NewAccountButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding NewAccount}"
                                    ToolTip="Сформировать новый счет">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\free-icon-account.png" Width="25" Height="25"/>
                                    <Label Content="Новый счет"/>
                                </StackPanel>
                            </Button>
                            <Separator/>
                            <Button Name="NewActButton" Style="{StaticResource ButtonOfOrder}" 
                                    Command="{Binding NewAct}" CommandParameter="{Binding ElementName=ListAccount, Path=SelectedItem}"
                                    ToolTip="Сформировать новый акт">
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="\Images\free-icon-act.png" Width="25" Height="25"/>
                                    <Label Content="Новый акт"/>
                                </StackPanel>
                            </Button>
                        </WrapPanel>
                        <Border Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2" Margin="2,2,2,2" BorderThickness="0.5" BorderBrush="Black" CornerRadius="5">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0.5,1" EndPoint="0.5,0">
                                    <GradientStop Color="LightSkyBlue" Offset="0" />
                                    <GradientStop Color="White" Offset="1" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <TextBlock Text="СЧЕТА" Margin="2" FontWeight="Bold" HorizontalAlignment="Center"/>
                        </Border>
                        <Grid Grid.Row="2" Grid.Column="0" Margin="2,0,2,2">
                            <Grid.RowDefinitions>
                                <!--список счетов-->
                                <RowDefinition Height="0,5*"/>
                                <!--список детализации счета-->
                                <RowDefinition Height="0,5*"/>
                                <!--итого по счету-->
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <ListView Grid.Row="0" Margin="2" Name="ListAccount"
                                      ItemsSource="{Binding ListPAD, UpdateSourceTrigger=PropertyChanged}" 
                                      ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto">
                                <ListView.InputBindings>
                                    <KeyBinding Key="Delete" Command="{Binding DeleteAccount}" CommandParameter="{Binding ElementName=ListAccount, Path=SelectedItem}"/>
                                </ListView.InputBindings>
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header=" Номер счета " DisplayMemberBinding="{Binding Path=AccountNumber}" Width="150"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Дата счета " DisplayMemberBinding="{Binding Path=AccountDate, ConverterCulture=ru-RU, StringFormat=\{0:dd.MM.yyyy\}}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Поставщик " 
                                                        DisplayMemberBinding="{Binding Path=ContractorName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                        HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="200"/>
                                        <GridViewColumn Header=" Основание " DisplayMemberBinding="{Binding Path=Footing, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                            <ListView Grid.Row="1" Margin="2" Name="ListAccountDetail" 
                                      ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                      ItemsSource="{Binding ElementName=ListAccount, Path=SelectedItem.DetailsList, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <ListView.InputBindings>
                                    <KeyBinding Key="Delete" Command="{Binding DeleteAccountDetail}">
                                        <KeyBinding.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                <Binding ElementName="ListAccount" Path="SelectedItem"/>
                                                <Binding ElementName="ListAccountDetail" Path="SelectedItem"/>
                                            </MultiBinding>
                                        </KeyBinding.CommandParameter>
                                    </KeyBinding>
                                </ListView.InputBindings>
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn x:Name="a_col1" Header=" Товары (работы, услуги) " DisplayMemberBinding="{Binding Path=ProductInfoForAccount}" 
                                                    HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn x:Name="a_col2" Header=" Кол-во " DisplayMemberBinding="{Binding Path=Quantity}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="100"/>
                                        <GridViewColumn x:Name="a_col3" Header=" Ед. изм. " DisplayMemberBinding="{Binding Path=UnitName}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn x:Name="a_col4" Header=" Цена " DisplayMemberBinding="{Binding Path=PricePerUnit, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="100"/>
                                        <GridViewColumn x:Name="a_col5" Header=" Сумма " DisplayMemberBinding="{Binding Path=Cost, ConverterCulture=ru-RU, StringFormat={}{0:C}}" 
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="100"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                            <Border Grid.Row="2" BorderBrush="DeepSkyBlue" BorderThickness="0.5">
                                <Grid Width="{Binding ElementName=ListAccountDetail, Path=ActualWidth}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="{Binding ElementName=a_col1, Path=ActualWidth}"/>
                                        <ColumnDefinition Width="{Binding ElementName=a_col2, Path=ActualWidth}"/>
                                        <ColumnDefinition Width="{Binding ElementName=a_col3, Path=ActualWidth}"/>
                                        <ColumnDefinition Width="{Binding ElementName=a_col4, Path=ActualWidth}"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="3" Text="ИТОГО: " FontWeight="Bold" HorizontalAlignment="Right"/>
                                    <TextBlock Grid.Column="4" Margin="10,0,0,0" Text="{Binding ElementName=ListAccount, Path=SelectedItem.TotalCost, ConverterCulture=ru-RU, StringFormat={}{0:C}, UpdateSourceTrigger=PropertyChanged}" 
                                               FontWeight="Bold"/>
                                </Grid>
                            </Border>
                        </Grid>
                        <ScrollViewer Grid.Row="2" Grid.Column="3" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <Grid Margin="5">
                                <!--поля для правки счета-->
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Column="0" Grid.Row="0" Text="Номер счета: " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="0" Text="{Binding ElementName=ListAccount, Path=SelectedItem.AccountNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                         IsEnabled="True" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="0" Grid.Row="1" Text="Покупатель: " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="1" Margin="0,5,0,0" IsEnabled="True" AcceptsReturn="True" AcceptsTab="True" 
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Order.Client.ClientInfoForAccount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                         TextWrapping="Wrap" MaxLines="3" MinLines="3"/>
                                <TextBlock Grid.Column="0" Grid.Row="2" Text="Поставщик: " VerticalAlignment="Center"/>
                                <ComboBox Grid.Column="1" Grid.Row="2" Margin="0,5,0,0" Name="ContractorNameComboBox"
                                          SelectionChanged="ContractorNameComboBox_SelectionChanged"
                                          ItemsSource="{Binding ListContractor}"
                                          DisplayMemberPath="NameForUI" SelectedValuePath="ID" VerticalAlignment="Center"
                                          SelectedValue="{Binding ElementName=ListAccount, Path=SelectedItem.ContractorID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBox Grid.Column="1" Grid.Row="3" AcceptsReturn="True" AcceptsTab="True" TextWrapping="Wrap"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         MaxLines="3" MinLines="3"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Contractor.ContractorInfoForAccount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="4" Text="Основание: " VerticalAlignment="Center"/>
                                <Grid Grid.Column="1" Grid.Row="4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0" VerticalAlignment="Center" HorizontalAlignment="Stretch"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Footing, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <TextBlock Text="Оплатить не позднее: " Style="{StaticResource UnderlineTextBlock}" VerticalAlignment="Center">
                                            <TextBlock.InputBindings>
                                                <MouseBinding Command="{Binding TextBlockMouseLeftClick}" CommandParameter="{Binding ElementName=DatePayBefore}" MouseAction="LeftClick"/>
                                            </TextBlock.InputBindings>
                                        </TextBlock>
                                        <DatePicker Name="DatePayBefore" IsTodayHighlighted="True"
                                                    SelectedDate="{Binding ElementName=ListAccount, Path=SelectedItem.PayBeforeDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="0,0,0,1"/>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Grid.Column="0" Grid.Row="5" Text="Товары (работы, услуги): " VerticalAlignment="Center"/>
                                <Grid Grid.Column="1" Grid.Row="5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0" Margin="0,5,5,5" TextWrapping="Wrap" AcceptsReturn="True"  
                                             VerticalAlignment="Center"
                                             Text="{Binding ElementName=ListAccountDetail, Path=SelectedItem.ProductInfoForAccount, Mode=TwoWay, 
                                             UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" SourceUpdated="TextBox_SourceUpdated"/>
                                    <CheckBox Grid.Column="1" Name="ManualInput" Margin="1,0,0,0" Content=" ручной ввод" VerticalContentAlignment="Center" 
                                              IsChecked="{Binding ElementName=ListAccount, Path=SelectedItem.IsManual, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True}" 
                                              Command="{Binding ManualInputAccount}" CommandParameter="{Binding ElementName=ListAccount, Path=SelectedItem}">
                                    </CheckBox>
                                </Grid>
                                <TextBlock Grid.Column="0" Grid.Row="6" Text="Количество: " VerticalAlignment="Center"/>
                                <StackPanel Grid.Column="1" Grid.Row="6" Orientation="Horizontal" HorizontalAlignment="Left">
                                    <TextBox IsEnabled="True" Margin="0,5,0,5" VerticalAlignment="Center" HorizontalAlignment="Left"
                                         Width="40"
                                         Text="{Binding ElementName=ListAccountDetail,Path=SelectedItem.Quantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, 
                                         ValidatesOnExceptions=True, ValidatesOnNotifyDataErrors=True,
                                         NotifyOnSourceUpdated=True}" SourceUpdated="TextBox_SourceUpdated"/>
                                    <TextBlock Text="  Ед. изм.: " HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    <TextBox Margin="1,5,0,0" IsEnabled="True" VerticalAlignment="Top" HorizontalAlignment="Left" Width="40"
                                         Text="{Binding ElementName=ListAccountDetail,Path=SelectedItem.UnitName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                         SourceUpdated="TextBox_SourceUpdated"/>
                                </StackPanel>
                                <StackPanel Grid.Column="0" Grid.Row="7" Orientation="Vertical">
                                    <Button Margin="4" Name="PrintAccountButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding PrintAccount}">
                                        <Button.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                <Binding ElementName="ListAccount" Path="SelectedItem"/>
                                                <Binding ElementName="AccountDate" Path="SelectedDate"/>
                                                <Binding ElementName="WithSignature" Path="IsChecked"/>
                                            </MultiBinding>
                                        </Button.CommandParameter>
                                        <StackPanel Orientation="Horizontal">
                                            <Image Margin="5,0,0,0" Source="\Images\free-icon-printer.png" Width="25" Height="25"/>
                                            <StackPanel Orientation="Vertical" Margin="7,0,0,0">
                                                <Label Content=" Печать на дату "/>
                                                <DatePicker Name="AccountDate" SelectedDate="{x:Static System:DateTime.Now}" IsTodayHighlighted="True" IsEnabled="True" 
                                                        VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                                <CheckBox Grid.Column="1" Grid.Row="7" Content=" с подписью и печатью" Name="WithSignature" VerticalAlignment="Center"/>
                            </Grid>
                        </ScrollViewer>
                        <Border Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Margin="2,2,2,2" BorderThickness="0.5" BorderBrush="Black" CornerRadius="5">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0.5,1" EndPoint="0.5,0">
                                    <GradientStop Color="LightSkyBlue" Offset="0" />
                                    <GradientStop Color="White" Offset="1" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <TextBlock Text="АКТЫ" Margin="2" FontWeight="Bold" HorizontalAlignment="Center"/>
                        </Border>
                        <Grid Grid.Row="4" Grid.Column="0" Margin="2,2,2,2">
                            <Grid.RowDefinitions>
                                <!--список актов-->
                                <RowDefinition Height="0,5*"/>
                                <!--список детализации акта-->
                                <RowDefinition Height="0,5*"/>
                            </Grid.RowDefinitions>
                            <ListView Grid.Row="0" Name="ListAct" 
                                      ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                      ItemsSource="{Binding ElementName=ListAccount, Path=SelectedItem.Acts}" KeyDown="ListAct_KeyDown">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header=" Номер акта " DisplayMemberBinding="{Binding Path=ActNumber}" Width="150"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Дата акта " DisplayMemberBinding="{Binding Path=ActDate, ConverterCulture=ru-RU, StringFormat=\{0:dd.MM.yyyy\}}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Поставщик " Width="250"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ElementName=ListAccount, Path=SelectedItem.ContractorName, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" 
                                                           TextWrapping="Wrap"/>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header=" Основание " DisplayMemberBinding="{Binding ElementName=ListAccount, Path=SelectedItem.Footing, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="200"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                            <ListView Grid.Row="1" Name="ListActDetail"
                                      ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                      ItemsSource="{Binding ElementName=ListAct, Path=SelectedItem.DetailsList}">
                                <ListView.InputBindings>
                                    <KeyBinding Key="Delete" Command="{Binding DeleteActDetail}">
                                        <KeyBinding.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                <Binding ElementName="ListAccount" Path="SelectedItem"/>
                                                <Binding ElementName="ListAct" Path="SelectedItem"/>
                                                <Binding ElementName="ListActDetail" Path="SelectedItem"/>
                                            </MultiBinding>
                                        </KeyBinding.CommandParameter>
                                    </KeyBinding>
                                </ListView.InputBindings>
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header=" Наименование работ, услуг " DisplayMemberBinding="{Binding Path=ProductInfoForAccount, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Кол-во " DisplayMemberBinding="{Binding Path=Quantity, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Ед. изм. " DisplayMemberBinding="{Binding Path=UnitName, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}"/>
                                        <GridViewColumn Header=" Цена " DisplayMemberBinding="{Binding Path=PricePerUnit, ConverterCulture=ru-RU, StringFormat={}{0:C}}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="100"/>
                                        <GridViewColumn Header=" Сумма " DisplayMemberBinding="{Binding Path=Cost, ConverterCulture=ru-RU, StringFormat={}{0:C}}"
                                                HeaderTemplate="{StaticResource ListViewHeaderTemplate}" Width="100"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                        <ScrollViewer Grid.Row="4" Grid.Column="3" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <Grid  Margin="5">
                                <!--поля для правки деталей акта-->
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Column="0" Grid.Row="0" Text="Номер акта " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="0" Text="{Binding ElementName=ListAct, Path=SelectedItem.ActNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                         IsEnabled="True" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="0" Grid.Row="1" Text="Исполнитель: " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="1" Margin="0,5,0,0" Name="MeasureMaxWidth" IsEnabled="True" TextWrapping="Wrap" AcceptsReturn="True" AcceptsTab="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         MaxLines="3" MinLines="3"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Contractor.ContractorInfoForAct, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="2" Text="Заказчик: " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="2" Margin="0,5,0,0" IsEnabled="True" TextWrapping="Wrap" AcceptsReturn="True" AcceptsTab="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         MaxLines="3" MinLines="3"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Order.Client.ClientInfoForAct, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="4" Text="Статус (УПД): " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="4" Margin="0,5,0,0" Width="20" HorizontalAlignment="Left" VerticalAlignment="Center"
                                     Text="{Binding ElementName=ListAct, Path=SelectedItem.UPDState, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="5" Text="Грузоотправитель (УПД): " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="5" Margin="0,5,0,0" TextWrapping="Wrap" AcceptsReturn="True" AcceptsTab="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         MaxLines="3" MinLines="3"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Contractor.ShipperInfoForSFUPD, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="6" Text="Грузополучатель (СФ, УПД): " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="6" Margin="0,5,0,0" TextWrapping="Wrap" AcceptsReturn="True" AcceptsTab="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         IsEnabled="{Binding Converter={StaticResource BoolNotBoolConverter}, ElementName=ListAccount, Path=SelectedItem.Order.Client.ConsigneeIsSame}"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Order.Client.ConsigneeForSFUPD, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <TextBlock Grid.Column="0" Grid.Row="7" Text="Грузополучатель (ТН): " VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Grid.Row="7" Margin="0,5,0,0" TextWrapping="Wrap" AcceptsReturn="True" AcceptsTab="True"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         MaxLines="3" MinLines="3"
                                         IsEnabled="{Binding Converter={StaticResource BoolNotBoolConverter}, ElementName=ListAccount, Path=SelectedItem.Order.Client.ConsigneeIsSame}"
                                         Text="{Binding ElementName=ListAccount, Path=SelectedItem.Order.Client.ConsigneeForTN, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <StackPanel Grid.Column="0" Grid.Row="8" Orientation="Vertical">
                                    <Button Margin="4" Name="PrintActButton" Style="{StaticResource ButtonOfOrder}" Command="{Binding PrintAct}">
                                        <Button.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiValueConverter}">
                                                <Binding ElementName="ListAccount" Path="SelectedItem"/>
                                                <Binding ElementName="ListAct" Path="SelectedItem"/>
                                                <Binding ElementName="ActDate" Path="SelectedDate"/>
                                                <Binding ElementName="TemplateAct" Path="IsChecked"/>
                                                <Binding ElementName="TemplateSFTN" Path="IsChecked"/>
                                                <Binding ElementName="TemplateUPD" Path="IsChecked"/>
                                            </MultiBinding>
                                        </Button.CommandParameter>
                                        <StackPanel Orientation="Horizontal">
                                            <Image Margin="5,0,0,0" Source="\Images\free-icon-printer.png" Width="25" Height="25"/>
                                            <StackPanel Orientation="Vertical" Margin="7,0,0,0">
                                                <Label Content=" Печать на дату "/>
                                                <DatePicker Name="ActDate" SelectedDate="{x:Static System:DateTime.Now}" IsTodayHighlighted="True" IsEnabled="True" 
                                                        VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Grid.Row="8" Orientation="Horizontal" Margin="3,0,0,0">
                                    <RadioButton GroupName="ActTemplate" Name="TemplateAct" IsChecked="True" Content=" Акт" VerticalContentAlignment="Center"/>
                                    <RadioButton GroupName="ActTemplate" Name="TemplateSFTN" Margin="3,0,0,0" Content=" СФ и ТН" VerticalContentAlignment="Center" />
                                    <RadioButton GroupName="ActTemplate" Name="TemplateUPD" Margin="3,0,0,0" Content=" УПД" VerticalContentAlignment="Center" />
                                </StackPanel>
                            </Grid>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </TabItem>
        </TabControl>
    </Grid>
</Window>
